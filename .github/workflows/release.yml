name: Release Xray Client

on:
  push:
    branches:
      - 'client'

jobs:
  job1:
    name: 构建xray客户端配置
    runs-on: ubuntu-20.04
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: 生成xray客户端配置
        run: python build.py ${{ secrets.XRAY_IP }} ${{ secrets.XRAY_DOMAIN }} ${{ secrets.XRAY_WINDOWS_KEY }} ${{ secrets.XRAY_TROJAN_KEY }}

      - name: 发布xray客户端http服务
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest 
        env:
          WELCOME: 'ssh scp ssh pipelines'
          LASTSSH: 'Doing something after copying'
        with:
          # HC代表发布xray配置的服务器
          host: ${{ secrets.HC_HOST }}
          user: ${{ secrets.HC_USER }}
          pass: ${{ secrets.HC_PASS }}
          port: ${{ secrets.HC_PORT }}
          connect_timeout: 20s
          first_ssh: |
            docker stop nginx
            mkdir -p /root/assets/config/client/qx
            mkdir -p /root/assets/config/client/trojan
            mkdir -p /root/assets/config/client/windows
          scp: |
            'dist/config.json' => /root/assets/config/client/windows
            'dist/policy.list' => /root/assets/config/client/qx
            'dist/policy.txt' => /root/assets/config/client/qx
            'dist/trojan.txt' => /root/assets/config/client/trojan
          last_ssh: |
            docker start nginx
            curl -L https://api.day.app/${{ secrets.BARK_TOKEN }}/xray客户端配置已更新
