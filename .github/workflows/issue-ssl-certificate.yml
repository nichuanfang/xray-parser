# æ³¨: å®šæ—¶ä»»åŠ¡çš„ymlåªæœ‰æ”¾åœ¨ä¸»åˆ†æ”¯ä¸Šé¢æ‰ç”Ÿæ•ˆ!
name: issue-ssl-certificate

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  # Checkout åˆ°çš„ç›®å½•
  CERTS_OUTPUT_BASE: certs
  # è¯ä¹¦è¾“å‡ºç›®å½•
  CERTS_OUTPUT_DIRECTORY: cinima.asia
  # è¯ä¹¦æ–‡ä»¶å
  FILE_FULLCHAIN: fullchain.pem
  # ç§é’¥æ–‡ä»¶å
  FILE_KEY: privatekey.key

on:
  # æ‰‹åŠ¨è§¦å‘ ç›¸å…³æ–‡æ¡£ https://docs.github.com/cn/actions/reference/events-that-trigger-workflows#workflow_dispatch
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
          - info
          - warning
          - debug
      tags:
        description: 'Test scenario tags'
        required: false
        type: boolean
      environment:
        description: 'Environment to run tests against'
        required: true
        type: choice
        options:
          - client
          - server

  schedule:
    - cron: '0 5 * * *'
jobs:
  issue-ssl-certificate:
    name: Issue SSL certificate
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: client

      # å®‰è£… acme.sh
      - name: Install acme.sh
        shell: bash
        run: curl -s https://get.acme.sh | sh

      # è§£å‹ acme.sh é…ç½®ä¿¡æ¯
      - name: Extract account files for acme.sh
        shell: bash
        run: |
          echo "$ACME_SH_ACCOUNT_TAR" | base64 -d | tar -C ~/.acme.sh -xz
        env:
          # Base64 ç¼–ç çš„ acme.sh é…ç½®ä¿¡æ¯
          ACME_SH_ACCOUNT_TAR: ${{ secrets.ACME_SH_ACCOUNT_TAR }}

      - name: ç”³è¯·è¯ä¹¦
        shell: bash
        run: |
          ~/.acme.sh/acme.sh --issue        \
            -d "vencenter.cn"   --dns dns_cf \
            -d "*.vencenter.cn" --dns dns_cf \
            --server letsencrypt

      # å¯¼å‡ºè¯ä¹¦
      - name: å¯¼å‡ºè¯ä¹¦
        shell: bash
        run: |
          ACME_SH_TEMP_DIR="$(mktemp -d)"
          ACME_SH_TEMP_FILE_FULLCHAIN="$ACME_SH_TEMP_DIR/fullchain.pem"
          ACME_SH_TEMP_FILE_KEY="$ACME_SH_TEMP_DIR/key.pem"

          ~/.acme.sh/acme.sh --install-cert -d "$ACME_SH_FIRST_DOMAIN" --fullchain-file "$ACME_SH_TEMP_FILE_FULLCHAIN" --key-file "$ACME_SH_TEMP_FILE_KEY"

          [[ -z "$ACME_SH_OUTPUT_FULLCHAIN" ]] || (mkdir -p "$(dirname "$ACME_SH_OUTPUT_FULLCHAIN")" && cp "$ACME_SH_TEMP_FILE_FULLCHAIN" "$ACME_SH_OUTPUT_FULLCHAIN")
          [[ -z "$ACME_SH_OUTPUT_KEY" ]] || (mkdir -p "$(dirname "$ACME_SH_OUTPUT_KEY")" && cp "$ACME_SH_TEMP_FILE_KEY" "$ACME_SH_OUTPUT_KEY")

          rm -rf "$ACME_SH_TEMP_DIR"
        env:
          # ä¿®æ”¹æ­¤å¤„çš„ example.com ä¸ºç”³è¯·æ—¶å¡«å†™çš„ç¬¬ä¸€ä¸ªåŸŸå
          ACME_SH_FIRST_DOMAIN: vencenter.cn
          ACME_SH_OUTPUT_FULLCHAIN: ${{ env.CERTS_OUTPUT_BASE }}/${{ env.CERTS_OUTPUT_DIRECTORY }}/${{ env.FILE_FULLCHAIN }}
          ACME_SH_OUTPUT_KEY: ${{ env.CERTS_OUTPUT_BASE }}/${{ env.CERTS_OUTPUT_DIRECTORY }}/${{ env.FILE_KEY }}

      - name: checkoutå‡ºdockeré¡¹ç›®
        uses: actions/checkout@v3.5.2
        with:
          repository: nichuanfang/docker
          path: docker
          ref: master
          token: ${{ secrets.GH_TOKEN }}

      - name: å¤åˆ¶è¯ä¹¦
        shell: bash
        run: |
          cp dist/cert.pem docker/dockerfile_work/xray/cert
          cp dist/key.pem docker/dockerfile_work/xray/cert
          chmod +x docker/dockerfile_work/xray/cert/*.pem

      - name: æ›´æ–°è¯ä¹¦æ–‡ä»¶
        uses: Smart-Transportation/push@v1.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: 'master'
          author_email: 'github-actions[bot]@users.noreply.github.com'
          author_name: 'github-actions[bot]'
          message: 'ğŸ³ chore: æ›´æ–°httpsè¯ä¹¦'
          directory: /home/runner/work/xray-parser/docker
          repository: nichuanfang/docker
