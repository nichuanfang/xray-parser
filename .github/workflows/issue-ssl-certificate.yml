# 注: 定时任务的yml只有放在主分支上面才生效!
name: issue-ssl-certificate

on:
  # 手动触发 相关文档 https://docs.github.com/cn/actions/reference/events-that-trigger-workflows#workflow_dispatch
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
          - info
          - warning
          - debug
      tags:
        description: 'Test scenario tags'
        required: false
        type: boolean
      environment:
        description: 'Environment to run tests against'
        required: true
        type: choice
        options:
          - client
          - server

  schedule:
    - cron: '0 5 1 * *'
jobs:
  issue-ssl-certificate:
    name: Issue SSL certificate
    runs-on: ubuntu-20.04
    steps:
      - name: 更新证书
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          DC_DOMAIN: ${{ secrets.DC_DOMAIN }}
        continue-on-error: true
        with:
          host: ${{ secrets.DC_HOST }}
          user: ${{ secrets.DC_USER }}
          pass: ${{ secrets.DC_PASS }}
          port: ${{ secrets.DC_PORT }}
          connect_timeout: 20s
          first_ssh: |
            curl -s https://get.acme.sh | sh
            apt-get install socat
            /bin/bash -c "$(curl -L https://github.com/nichuanfang/config-server/raw/master/xray/xray_cert_renew.sh)" $DC_DOMAIN 'github-actions[bot]' 'github-actions[bot]@users.noreply.github.com'
            curl -L https://api.day.app/${{ secrets.BARK_TOKEN }}/xray服务端配置已更新
