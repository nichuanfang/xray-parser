name: Release Xray Server
on:
  push:
    branches:
      - 'server'
jobs:
  job:
    name: ÊûÑÂª∫ÈïúÂÉè
    runs-on: ubuntu-20.04
    steps:
      - name: checkoutÂá∫xray-parserÈ°πÁõÆ
        uses: actions/checkout@v3.5.2
        with:
          repository: nichuanfang/xray-parser
          path: xray-parser
          ref: server
          token: ${{ secrets.GH_TOKEN }}

      - name: checkoutÂá∫dockerÈ°πÁõÆ
        uses: actions/checkout@v3.5.2
        with:
          repository: nichuanfang/docker
          path: docker
          ref: master
          token: ${{ secrets.GH_TOKEN }}

      - name: xray-parser=>docker
        run: cp -r $GITHUB_WORKSPACE/xray-parser $GITHUB_WORKSPACE/docker/dockerfile_work/xray

      - name: ÂØºÂÖ•pip‰æùËµñ
        run: pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r $GITHUB_WORKSPACE/docker/dockerfile_work/xray/xray-parser/requirements.txt

      - name: ÈÖçÁΩÆxrayÁéØÂ¢É Áî®Êù•ÁîüÊàêÊúçÂä°Á´ØÂíåÂÆ¢Êà∑Á´ØÈÄöÁî®Êï∞ÊçÆ
        run: |
          sudo apt-get install wget unzip -y
          wget https://github.com/XTLS/Xray-core/releases/download/v1.8.1/Xray-linux-64.zip
          unzip Xray-linux-64.zip
          chmod +x ./xray
          cp ./xray $GITHUB_WORKSPACE/docker/dockerfile_work/xray/xray-parser

      - name: Êõ¥Êñ∞config.jsonÂíådocker-compose.yml
        run: |
          cd $GITHUB_WORKSPACE/docker/dockerfile_work/xray/xray-parser
          python build.py ${{vars.VLESS_DEST}} ${{vars.VLESS_SERVER_NAMES}} ${{vars.VLESS_PORT}} ${{vars.TROJAN_PORT}}

      - name: Êèê‰∫§‰πãÂâçÁöÑÂáÜÂ§áÂ∑•‰Ωú
        run: |
          mkdir -p $GITHUB_WORKSPACE/docker/dockerfile_work/xray/config
          cp -r $GITHUB_WORKSPACE/docker/dockerfile_work/xray/xray-parser/dist/config.json $GITHUB_WORKSPACE/docker/dockerfile_work/xray/config

      - name: ÂèëÂ∏ÉxrayÊúçÂä°Á´ØhttpÊúçÂä°
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        continue-on-error: true
        env:
          WELCOME: 'ssh scp ssh pipelines'
          LASTSSH: 'Doing something after copying'
        with:
          # HC‰ª£Ë°®ÂèëÂ∏ÉxrayÈÖçÁΩÆÁöÑÊúçÂä°Âô®
          host: ${{ secrets.HC_HOST }}
          user: ${{ secrets.HC_USER }}
          pass: ${{ secrets.HC_PASS }}
          port: ${{ secrets.HC_PORT }}
          connect_timeout: 20s
          first_ssh: |
            docker stop nginx
            mkdir -p /root/assets/config/server
          scp: |
            './docker/dockerfile_work/xray/xray-parser/dist/config.json' => /root/assets/config/server
          last_ssh: |
            docker start nginx
            curl -L https://api.day.app/${{ secrets.BARK_TOKEN }}/xrayÊúçÂä°Á´ØÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞

      # Âà†Èô§dockerÈ°πÁõÆÁöÑxray-parserÁõÆÂΩï
      - name: Âà†Èô§dockerÈ°πÁõÆÁöÑxray-parserÁõÆÂΩï
        run: rm -rf $GITHUB_WORKSPACE/docker/dockerfile_work/xray/xray-parser

      - name: Êõ¥Êñ∞dockerÈ°πÁõÆÁöÑconfig.jsonÂíådocker-compose.yml
        uses: Smart-Transportation/push@v1.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: 'master'
          author_email: 'github-actions[bot]@users.noreply.github.com'
          author_name: 'github-actions[bot]'
          message: 'üê≥ chore: Êõ¥Êñ∞xrayÊúçÂä°Á´ØÈÖçÁΩÆÊñá‰ª∂'
          directory: /home/runner/work/xray-parser/xray-parser/docker
          repository: nichuanfang/docker

      - name: ÈÉ®ÁΩ≤ÂêØÂä®xray
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        continue-on-error: true
        env:
          WELCOME: 'ssh scp ssh pipelines'
          LASTSSH: 'Doing something after copying'
        with:
          # DC‰ª£Ë°®ÈÉ®ÁΩ≤xrayÁöÑÊúçÂä°Âô®
          host: ${{ secrets.DC_HOST }}
          user: ${{ secrets.DC_USER }}
          pass: ${{ secrets.DC_PASS }}
          port: ${{ secrets.DC_PORT }}
          connect_timeout: 20s
          first_ssh: |
            apt-get update
            apt-get install git -y
            apt-get install docker.io -y
            curl -L "https://github.com/docker/compose/releases/download/1.25.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            ln -fs /usr/local/bin/docker-compose /usr/bin/docker-compose
          scp: |
            './docker/dockerfile_work/xray/.git-credentials' => /root/
            './docker/dockerfile_work/xray/.gitconfig' => /root/
            './docker/dockerfile_work/xray/hook.sh' => /root/
          last_ssh: |
            chmod +x /root/hook.sh
            bash /root/hook.sh
            chmod +x /root/docker/dockerfile_work/xray/tls-ping.sh
            docker-compose -f /root/docker/dockerfile_work/xray/docker-compose.yml down
            docker-compose -f /root/docker/dockerfile_work/xray/docker-compose.yml pull
            docker-compose -f /root/docker/dockerfile_work/xray/docker-compose.yml up -d
            docker image prune -f -a
            curl -L https://api.day.app/${{ secrets.BARK_TOKEN }}/xrayÊúçÂä°Â∑≤ÂêØÂä®
