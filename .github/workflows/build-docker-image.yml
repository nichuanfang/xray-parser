name: 生成自定义xray服务器镜像
on:
  push:
    branches:
      - 'server'
jobs:
  job:
    name: 构建镜像
    runs-on: ubuntu-20.04
    steps:
      - name: checkout出xray-parser项目
        uses: actions/checkout@v3.5.2
        with:
          repository: nichuanfang/xray-parser
          path: xray-parser
          ref: server
          token: ${{ secrets.GH_TOKEN }}

      - name: checkout出docker项目
        uses: actions/checkout@v3.5.2
        with:
          repository: nichuanfang/docker
          path: docker
          ref: master
          token: ${{ secrets.GH_TOKEN }}

      - name: xray-parser=>docker
        run: mv $GITHUB_WORKSPACE/xray-parser $GITHUB_WORKSPACE/docker/dockerfile_work/xray

      - name: 导入pip依赖
        run: pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r $GITHUB_WORKSPACE/docker/dockerfile_work/xray/xray-parser/requirements.txt

      # - name: 生成config.json 与 nginx配置文件
      # run: python $GITHUB_WORKSPACE/docker/dockerfile_work/xray/xray-parser/build.py

      - name: 启动服务
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          WELCOME: 'ssh scp ssh pipelines'
          LASTSSH: 'Doing something after copying'
        with:
          host: ${{ secrets.DC_HOST }}
          user: ${{ secrets.DC_USER }}
          pass: ${{ secrets.DC_PASS }}
          port: ${{ secrets.DC_PORT }}
          connect_timeout: 2000s
          first_ssh: |
            apt-get install git -y
            apt-get install docker.io -y
            curl -L "https://github.com/docker/compose/releases/download/1.25.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            ln -fs /usr/local/bin/docker-compose /usr/bin/docker-compose
          scp: |
            './docker/dockerfile_work/xray/.git-credentials' => /root/
            './docker/dockerfile_work/xray/.gitconfig' => /root/
            './docker/dockerfile_work/xray/hook.sh' => /root/
          last_ssh: |
            chmod +x /root/hook.sh
            bash /root/hook.sh
            cd /root/docker/dockerfile_work/xray 
            docker-compose down
            docker-compose pull
            docker-compose up -d
            curl -L https://api.day.app/${{ secrets.BARK_TOKEN }}/xray服务已启动
